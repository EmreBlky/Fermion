<html>

<head>
	<style>
		body {
			background-color: #464646 !important;
			-webkit-app-region: drag;
		}

		* {
			font-family: monospace;
			line-height: 10px;
		}

		::-webkit-scrollbar {
			width: 0px;
		}

		p, td, th {
			color: #ffffff !important;
		}

		p {
			font-weight: bold;
			padding-top: 50%;
		}

		div.barFrame {
			user-select: none;
			text-align:right;
			display:block;
			padding-right:5px;
			padding-top:5px;
			padding-bottom:5px;
			background-color:#ee6055;
			position:fixed;
			top:0;
			width:100%;
		}
		div.dataFrame {
			-webkit-app-region:no-drag;
			position:fixed;
			top:40px;
        	margin:4px, 4px; 
        	padding:4px;
        	overflow-x: hidden; 
        	overflow-x: auto; 
        	text-align:justify;
			overflow-y:scroll;
			height: 94vh;
			width: 100%;
        }
	</style>
	<link rel="stylesheet" href="../assets/css/bootstrap.css">
</head>

<body>
	<div class="container-fluid">
		<div class="row barFrame">
			<a id="CloseProc" href="#">
				<img src="../assets/img/x.png" height=30px width=26px style="-webkit-app-region: no-drag;"><br />
			</a>
		</div>

		<div id="DataContainer" class="row dataFrame">
			<table id="ProcSet" class="table table-borderless table-hover table-sm">
				<thead>
					<tr>
						<th scope="col">Icon</th>
						<th scope="col">User</th>
						<th scope="col">PID</th>
						<th scope="col">PPID</th>
						<th scope="col">Process</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
		</div>
		<div id="IsError"></div>
	</div>

	<script type="text/javascript">
		const frida = require('frida');
		// Overwrite default node.js prop to get Jquery working
		window.$ = window.jQuery = require('jquery');

		// Get device currently selected
		url = global.location;
		deviceId = new URL(url).searchParams.get('deviceId');

		// Retrieve device list
		async function getDeviceList(devInst) {
			var dm = await frida.getDeviceManager();
			// If the device is a remote socket we need to add it
			// manually
			if (devInst.startsWith("socket@")) {
				var sRemoteSocket = devInst.split('@')[1];
				dm.addRemoteDevice(sRemoteSocket);
			}
			var dev = await dm.enumerateDevices();
			return dev;
		}

		// There is a bug in the latest Frida, a delay in the device
		// listing for non-default entries. All we do here is try 
		// three times and sleep 1000ms.
		// Reff: https://github.com/frida/frida/issues/1111
		const sleep = (milliseconds) => {
			return new Promise(resolve => setTimeout(resolve, milliseconds))
		}

		// Populate poc list
		async function getProcList() {
			// Make sure the device list has updated
			if (atob(deviceId) != "local") {
				for (i = 0; i < 3; i++) {
					var dev = await getDeviceList(atob(deviceId));
					if (dev.length > 2) {
						break;
					}
					await sleep(1000);
				}
			}
			let currentDevice = await frida.getDevice(atob(deviceId));
			let Applications = await currentDevice.enumerateProcesses({scope:"full"});
			return Applications;
		}
		getProcList().then(data => {
			// Insert separator
			var table = document.getElementById("ProcSet");
			var row = table.insertRow(table.length);
			row.insertCell(0).innerHTML = "----"
			row.insertCell(1).innerHTML = "----"
			row.insertCell(2).innerHTML = "---"
			row.insertCell(3).innerHTML = "----"
			row.insertCell(4).innerHTML = "-------"
			// Sort array
			data.sort((a, b) => (a.pid > b.pid) ? 1 : -1)

			// Did we re-write the table?
			var rewroteTable = false;

			// Populate table
			for (var i = 0; i < data.length; i++) {
				var table = document.getElementById("ProcSet");

				// Do we have icons to render?
				if (!data[i].parameters.hasOwnProperty("icons")) {
					if (!rewroteTable) {
						// We don't so re-write table
						var rows = table.rows;
						rows[0].deleteCell(0);
						rows[1].deleteCell(0);

						// Mark as finished
						rewroteTable = true;
					}
				} else {
					// Do we support the icon?
					if (data[i].parameters.icons[0].format != "rgba") {
						// We don't so re-write table
						var rows = table.rows;
						rows[0].deleteCell(0);
						rows[1].deleteCell(0);

						// Mark as finished
						rewroteTable = true;
					}
				}

				var row = table.insertRow(table.length);

				if (!rewroteTable) {
					row.insertCell(0).innerHTML = '<canvas id="CANVAS-Ico-' + data[i].pid + '" width="32" height="18"></canvas>';
					var user = row.insertCell(1);
					var pid = row.insertCell(2);
					var ppid = row.insertCell(3);
					var name = row.insertCell(4);
					makeIconCanvas(data[i]);
				} else {
					var user = row.insertCell(0);
					var pid = row.insertCell(1);
					var ppid = row.insertCell(2);
					var name = row.insertCell(3);
				}

				user.innerHTML = data[i].parameters.user;
				ppid.innerHTML = data[i].parameters.ppid;
				pid.innerHTML = data[i].pid;
				name.innerHTML = data[i].name;
			}
		}).catch((err) => {
			$("#ProcSet").remove();
			var node = document.createElement("p");
			var errMsg = document.createTextNode(err.message);
			node.appendChild(errMsg);
			document.getElementById("DataContainer").appendChild(node);
		});

		// Canvas generator
		function makeIconCanvas(data) {
			try {
				var uint8RGBA = data.parameters.icons[0].image;
				var c = document.getElementById("CANVAS-Ico-" + data.pid);
				var ctx = c.getContext("2d");
				var imgData = ctx.createImageData(16, 16);
				
				for (var i = 0; i < imgData.data.length; i += 4) {
				  imgData.data[i+0] = uint8RGBA[i+0];
				  imgData.data[i+1] = uint8RGBA[i+1];
				  imgData.data[i+2] = uint8RGBA[i+2];
				  imgData.data[i+3] = uint8RGBA[i+3];
				}

				ctx.putImageData(imgData, 0, 0);
			} catch { }
		}

		// Close window handler
		document.getElementById("CloseProc").onclick = function () {
			window.close();
		}
	</script>
</body>

</html>